---
title: æ–‡ç§‘ç”Ÿä¹Ÿèƒ½æ‡‚çš„ Rust async æœºåˆ¶
date: 2022-08-07 21:12:45
lastmod: 2022-08-10 11:07:00
tags:
  - Rust
  - async
  - easy
  - simple
categories: Developments
---

## èƒŒæ™¯

<https://twitter.com/repsiace/status/1554103778994900992/>

![Rust async åˆ°åº•æ˜¯ä»€ä¹ˆå•Šå•Šå•Šå•Š](https://assets.blog.pan93.com/what-is-rust-async/20220807130414.webp)

> ä¿®æ”¹ä¸€ä¸‹ï¼šwork stealing, thread-per-core, waker, mpsc, task queue åªæœ‰ä»–ä»¬æ‡‚... æ­£å¸¸äººä¸å¯èƒ½çœ‹æ‡‚ â€“ [@twicemoemoe, 22-08-02](https://twitter.com/twicemoemoe/status/1554305217134735362)

ä½œä¸ºä¸€ä¸ªæ–‡ç§‘ç”Ÿï¼Œå…¶å®è§‰å¾— async çœŸçš„æ²¡æœ‰æƒ³è±¡ä¸­çš„è¿™ä¹ˆå›°éš¾ â‹¯â‹¯ ğŸ˜‚ æˆ–è®¸æ­é…ä¸€äº›å›¾ç‰‡ä¼šå¥½æ‡‚å¾ˆå¤šå§ã€‚

## TL;DR ä¸åºŸè¯ç‰ˆæœ¬

- **Sync**ï¼ˆåŒæ­¥ï¼‰ï¼šä¸€ä»¶äº‹æƒ…åšå®Œä¹‹åï¼Œå†åšä¸‹ä¸€ä»¶äº‹æƒ…ã€‚
  - **blocking**ï¼ˆå µå¡ï¼‰ï¼šæŒ‡â€œç­‰ä¸€ä»¶äº‹æƒ…â€çš„è¡Œä¸ºã€‚
- **Async**ï¼ˆå¼‚æ­¥ï¼‰ï¼šä¸€ä»¶äº‹æƒ…è¿˜æ²¡å®Œæˆï¼Œå¯ä»¥åšå…¶ä»–ä¸å†²çªçš„äº‹æƒ…ã€‚
  - **concurrency**ï¼ˆå¹¶å‘ï¼‰ï¼šç¨‹åº **æ¶æ„** ä¸­ï¼Œå„ä¸ªä»»åŠ¡å¯ä»¥ **ç‹¬ç«‹è¿è¡Œ** çš„ç‰¹æ€§ã€‚
    - **future**ï¼šRust ä¸­çš„ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡çš„è¡¨ç¤ºã€‚
    - **polling**ï¼šä¸åœåœ°è¯¢é—®ä»»åŠ¡ï¼Œç¡®è®¤äº‹æƒ…æ˜¯å¦å·²ç»å®Œæˆã€‚
    - **event-driven**ï¼šäº‹æƒ…å®Œæˆåï¼Œä»»åŠ¡è‡ªå·±å‘é€šçŸ¥è¡¨æ˜å®Œæˆã€‚
  - **parallelism**ï¼ˆå¹¶è¡Œï¼‰ï¼šåŒæ—¶ **è¿è¡Œ** æ•°ä¸ªç¨‹åºçš„è¡Œä¸ºã€‚
    - **thread**ï¼ˆçº¿ç¨‹ã€çº¿ç¨‹ï¼‰ï¼šç³»ç»Ÿè¿›ç¨‹ï¼ˆä»»åŠ¡é›†ï¼‰çš„åŸºæœ¬å•å…ƒã€‚thread é€šå¸¸æ˜¯äº¤ç”± CPU å†…æ ¸è¿è¡Œã€‚
      - **spawn**ï¼ˆç”Ÿæˆï¼‰ï¼šæŒ‡äº§ç”Ÿ thread çš„è¡Œä¸ºã€‚
      - **thread pool**ï¼ˆçº¿ç¨‹æ± ï¼‰ï¼šå°† thread é«˜æ•ˆåˆ†é…ç»™æ¯ä¸ªä»»åŠ¡çš„åœ°æ–¹ã€‚
- **Async runtime**: ä»¥ tokio ä¸ºä¾‹
  - **join** (macro)ï¼šå¹¶å‘è¿è¡Œ async å‡½æ•°ï¼Œå¹¶åœ¨å…¨éƒ¨å®Œæˆåå›ä¼ ã€‚
  - **select** (macro)ï¼šå“ªä¸ª async å‡½æ•°å¿«ï¼Œå›ä¼ é‚£ä¸ª async å‡½æ•°çš„ç»“æœã€‚
  - **main** (attribute macro)ï¼šåœ¨ main() åˆå§‹åŒ– runtimeã€‚
  - **block_on**ï¼šåœ¨ sync ä¸Šè¿è¡Œ async å‡½æ•°ã€‚
  - **spawn**ï¼šå¹¶è¡Œè¿è¡Œ async å‡½æ•°ã€‚
  - **spawn_blocking**ï¼šåœ¨å¼‚æ­¥å‡½æ•°é‡Œé¢ï¼Œä¸ºä¸€ä¸ªé«˜è€—æ—¶ä¸”åŒæ­¥ (blocking) çš„å‡½æ•°å¦è¾Ÿæ–°çº¿ç¨‹ (thread)ã€‚

## åŒæ­¥ (Synchronous) è·Ÿå¼‚æ­¥ (Asynchoronous)

â€œ**åŒæ­¥**â€å°±æ˜¯æ•´ä¸ªç¨‹åºç­‰ä¸€ä»¶äº‹æƒ…å®Œæˆï¼ˆ**blocking**ï¼Œå µå¡ï¼‰ã€‚â€œ**å¼‚æ­¥**â€åˆ™æ˜¯ä¸€ä»¶äº‹æƒ…è¿˜æ²¡å®Œæˆï¼Œå¯ä»¥åšå…¶ä»–ä¸å†²çªçš„äº‹æƒ…ã€‚

å°±ä»¥æ—©é¤æ¥è¯´ï¼Œâ€œåŒæ­¥â€å°±åƒæ˜¯ç­‰åå¸çƒ¤å®Œä¹‹åï¼Œæ‰å»å‡†å¤‡èŠ±ç”Ÿé…±ï¼ˆ**æ¯ä»¶ä»»åŠ¡å¾ªåºæ¸è¿›åœ°è¿è¡Œ**ï¼‰ï¼›â€œå¼‚æ­¥â€å°±åƒæ˜¯åå¸æ­£åœ¨çƒ¤çš„æ—¶å€™ï¼Œå°±å…ˆå‡†å¤‡èŠ±ç”Ÿé…±ï¼ˆ**æ¯ä»¶ä»»åŠ¡å¹¶å‘åœ°è¿è¡Œ**ï¼‰ã€‚

![åŒæ­¥å’Œå¼‚æ­¥çš„å›¾è§£ã€‚](https://assets.blog.pan93.com/what-is-rust-async/async-sync.webp)

## å¹¶å‘ (Concurrency) ä¸å¹¶è¡Œ (Parallelism)

åˆšæ‰æœ‰æåˆ°â€œåå¸æ­£åœ¨çƒ¤çš„æ—¶å€™ï¼Œå°±å…ˆå‡†å¤‡èŠ±ç”Ÿé…±â€æ˜¯ä¸ª **å¹¶å‘** è¡Œä¸ºã€‚

**å¹¶å‘** å°±æ˜¯æŒ‡ç¨‹åºæ¶æ„ï¼Œä»»åŠ¡å¯ä»¥äº’ä¸ç›¸å…³è¿è¡Œçš„ç‰¹æ€§ã€‚æˆ‘ä»¬å¯ä»¥ç§°â€œåå¸æ­£åœ¨çƒ¤â€å’Œâ€œå‡†å¤‡èŠ±ç”Ÿé…±â€æ˜¯ä¸ªç‹¬ç«‹ä»»åŠ¡ï¼Œè€Œæˆ‘ä»¬å¯ä»¥ **å¹¶å‘** åœ°è¿›è¡Œè¿™äº›ä»»åŠ¡ã€‚

è¯´åˆ°å¹¶å‘ï¼Œé‚£ä»€ä¹ˆæ˜¯ **å¹¶è¡Œ** å‘¢ï¼Ÿ

å‡å¦‚ä½ å¦ˆä¹Ÿæƒ³å¸®ä½ ä¸€èµ·åšæ—©é¤ï¼Œè€Œä½ è´Ÿè´£â€œçƒ¤åœŸå¸ã€å‡†å¤‡é…±æ–™â€ï¼Œè€Œä½ å¦ˆè´Ÿè´£â€œç…è›‹ã€æ‘†ç›˜â€ã€‚ä½ åšè‡ªå·±çš„ä»»åŠ¡ã€è€Œä½ å¦ˆåšè‡ªå·±çš„ä»»åŠ¡â€”â€”è¿™å°±æ˜¯ **å¹¶è¡Œ**ã€‚

![å¹¶å‘æ­é…å¹¶è¡Œã€‚](https://assets.blog.pan93.com/what-is-rust-async/parallelism.webp)

å›åˆ°ç”µè„‘çš„ä¾‹å­ä¸Šã€‚æˆ‘ä»¬å¯ä»¥æŠŠâ€œä½ â€å’Œâ€œä½ å¦ˆâ€æ¯”æ‹Ÿä¸º **CPU å†…æ ¸ (core)** ï¼Œåˆ†é…ç»™ä½ å’Œä½ å¦ˆçš„ä¸€å¤§å †ç‹¬ç«‹ä»»åŠ¡å«åš **çº¿ç¨‹ (thread)** ã€‚**å¹¶å‘** å°±æ˜¯å·¥ä½œå•å…ƒè‡ªå·±ç”¨å¼‚æ­¥çš„æ–¹å¼å¤„ç†ä»»åŠ¡ï¼›**å¹¶è¡Œ** å°±æ˜¯åˆ†é…å…¶ä»–å·¥ä½œå•å…ƒå¤„ç†ä»»åŠ¡ã€‚

### é«˜çº§é˜…è¯»ï¼šçº¿ç¨‹æ±  (thread pool)

ä½ ç”µè„‘çš„å†…æ ¸æ˜¯æœ‰é™çš„ã€‚å°±ä»¥ Apple M1 è¿™é¢— CPU æ¥è¯´ï¼Œæœ€å¤šä¹Ÿå°±åªæœ‰ 8 ä¸ªå†…æ ¸ã€‚é‚£è¦æ€ä¹ˆé«˜æ•ˆçš„æŠŠä¸€å¤§å †çº¿ç¨‹ï¼Œéƒ½åˆ†é…åˆ°è¿™äº› CPU ä¸Šå‘¢ï¼Ÿ

æˆ‘ä»¬é€šå¸¸æŠŠè¿™ä¸ªâ€œåˆ†é…â€å«åšè°ƒåº¦ (schedulingï¼Œæ’ç¨‹ï¼‰ã€‚é¦–å…ˆï¼Œæœ€ç®€å•çš„åšæ³•å°±æ˜¯è‡ªå·±è·Ÿç³»ç»Ÿå¼€çº¿ç¨‹ï¼ˆé€šå¸¸æˆ‘ä»¬æŠŠè¿™ç§çº¿ç¨‹å«åš **OS thread**ï¼‰ï¼š

![OS Thread](https://assets.blog.pan93.com/what-is-rust-async/os-thread.webp)

åœ¨ Rust é‡Œé¢ï¼Œä½¿ç”¨ OS thread æ˜¯éå¸¸ç®€å•çš„ï¼š

```rs
let handle = std::thread::spawn(|| {
  /* ä½ çš„åŒæ­¥ä½œä¸š */
});
```

è¿™æ ·çš„å¥½å¤„æ˜¯ä¸éœ€è¦åœ¨ç¨‹åºé‡Œé¢åŒ…ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œä½†ç¼ºç‚¹æ˜¯çº¿ç¨‹çš„ **spawn** ç”Ÿæˆï¼ˆæŠŠä»»åŠ¡åˆ†é…ç»™å®¶äººï¼‰å’Œ **destroy** é”€æ¯ï¼ˆå‘Šè¯‰å®¶äººä¸ç”¨ç»§ç»­è¿è¡Œä»»åŠ¡ï¼‰éƒ½å¾—æ‰¾ä½ çš„æ“ä½œç³»ç»Ÿï¼ˆç®¡å®¶ï¼‰æ“ä½œã€‚é‚£å¦‚æœæˆ‘ä»¬å¯ä»¥è‡ªå·±è°ƒåº¦ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½å‡å°‘æ‰¾æ“ä½œç³»ç»Ÿï¼ˆç®¡å®¶ï¼‰çš„å¼€é”€ï¼Œç”šè‡³æ˜¯åšåˆ°æ›´å¤šæ›´é«˜æ•ˆçš„äº‹æƒ…ï¼ˆæ¯”å¦‚åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œé¢è¿è¡Œæ•°ä¸ªå¹¶å‘ä»»åŠ¡ï¼‰ï¼Ÿ

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å…ˆè·Ÿç®¡å®¶è¯´â€œæˆ‘éœ€è¦ N ä¸ªå¯ä»¥åˆ†é…å®¶äººä»»åŠ¡çš„çº¿ç¨‹ï¼Œâ€ç„¶åæŠŠè¿™äº›çº¿ç¨‹éƒ½æ”¾è¿›å»æˆ‘ä»¬çš„ `thread pool`ã€‚æ¥ä¸‹æ¥ç¨‹åºéœ€è¦ thread è¿è¡Œä»»åŠ¡ï¼Œå°±è¯· `thread pool` åˆ†é…ã€‚è€Œæˆ‘ä»¬ä» `thread pool` åˆ†é…åˆ°çš„çº¿ç¨‹ï¼Œå°±æ˜¯ **green thread**ã€‚

ç”¨æ–‡å­—æè¿°å¤ªæ··ä¹±ï¼Œç›´æ¥ç”¨å›¾è§£å§ï¼š

![Green threads](https://assets.blog.pan93.com/what-is-rust-async/green-thread.webp)

ä½†å‡å¦‚æ¯ä¸ª threads é‡Œé¢éƒ½æ˜¯ä¼šå µä½ç¨‹åºçš„ä»»åŠ¡ (blocking)ï¼Œé‚£ Thread Pool é‡Œé¢çš„ OS Thread å°±å¾—ç­‰è¿™äº›ä»»åŠ¡å®Œæˆï¼Œæœ€ååè€Œæ²¡æœ‰è¾¾åˆ°é¢„æœŸçš„é«˜æ•ˆåˆ†é…ã€‚å› æ­¤ï¼Œå¦‚æœ threads é‡Œé¢æ˜¯å®Œå…¨ sync çš„ä»»åŠ¡ï¼Œå°± **æ²¡æœ‰å¿…è¦ç”¨ä¸Š thread pool**ï¼Œè®© OS åˆ†é…å³å¯ã€‚

![Thread pool in sync](https://assets.blog.pan93.com/what-is-rust-async/thread-pool-sync.webp)

åä¹‹ï¼Œå¦‚æœ threads é‡Œé¢çš„ä»»åŠ¡å¯ä»¥å¹¶å‘ï¼Œå› ä¸ºä¸€ä¸ª thread å¯ä»¥å¹¶å‘è¿è¡Œå¤šä¸ªä»»åŠ¡ï¼Œthread pool çš„å®‰æ’å°±ä¼šæ˜¾å¾—æ¯” OS threads é«˜æ•ˆè®¸å¤šï¼š

![Thread pool in async](https://assets.blog.pan93.com/what-is-rust-async/thread-pool-async.webp)

## é«˜çº§é˜…è¯»ï¼šFuture ä¸ Executor

> å¯¹åº•å±‚æ¯”è¾ƒæ²¡å…´è¶£ï¼Ÿå¯ä»¥å…ˆçœ‹ [Async å‡½æ•°ã€åŒºå—å’Œ await](#async-å‡½æ•°åŒºå—å’Œ-await)ã€‚

åŸºç¡€ç†è®ºç»“æŸï¼Œæ‹‰å›â€œä»»åŠ¡â€å’Œ Rust æœ¬èº«ã€‚ä½ æˆ–è®¸ä¼šå¾ˆå¥½å¥‡â€œæ€ä¹ˆè®© Rust çŸ¥é“ä¸€ä¸ªä»»åŠ¡æ˜¯å¦å®Œæˆï¼Ÿâ€

è¿™é‡Œå°±è¦æåˆ° Rust çš„ Future äº†ã€‚Rust çš„ **Future** å°±æ˜¯ä¸€ä¸ªå¯å¹¶å‘ä»»åŠ¡çš„æŠ½è±¡è¡¨ç¤ºã€‚è€Œ **Executor** å°±æ˜¯è´Ÿè´£è½®è¯¢ (**polling**) Futures çš„ç¨‹åºã€‚æŠŠæˆ‘ä»¬ä¹‹å‰çš„â€œå¼‚æ­¥â€å›¾è§£ç”¨ Executor çš„è§†è§’æç»˜å‡ºæ¥ï¼š

![Executor å†…éƒ¨åŸºæœ¬ä¸Šæ€ä¹ˆåˆ¤æ–­çš„](https://assets.blog.pan93.com/what-is-rust-async/how-executors-work.webp)

ç”¨æ–‡å­—è¡¨è¾¾ï¼š

1. Executor ä¼šä» Future Receiver æŠ“å‡ºä¸€ä¸ª Futureã€‚
2. Executor è¿è¡Œè¿™ä¸ªä»»åŠ¡çš„ `poll()`ï¼Œå¹¶è§‚å¯Ÿå…¶å›åº”ã€‚
3. å¦‚æœæ˜¯ `Poll::Pending`ï¼ˆå¤„ç†ä¸­ï¼‰ï¼Œå°±ç»§ç»­å¤„ç†ä¸‹ä¸ªä»»åŠ¡ã€‚
4. å¦‚æœæ˜¯ `Poll::Ready(T)`ï¼ˆå·²å®Œæˆï¼Œå›ä¼ å€¼æ˜¯ Tï¼‰ï¼Œåˆ™å°†å›ä¼ å€¼äº¤ç»™éœ€æ±‚æ–¹ã€‚

ä½†è¿™ä¸ªæ–‡å­—æµç¨‹æœ‰ä¸ªé—®é¢˜ï¼š`poll()` åªä¼šè¿è¡Œä¸€æ¬¡å—ï¼Ÿå¦‚æœä¼šè¿è¡Œæ•°æ¬¡ï¼Œé‚£ `poll()` ä¸‹æ¬¡ä¼šåœ¨ä»€ä¹ˆæ—¶å€™è¿è¡Œï¼Ÿè¿™é‡Œå°±å¾—æåˆ° Rust çš„ **waker** æœºåˆ¶äº†ã€‚æ¯ä¸€æ¬¡ `poll()`ï¼ŒExecutor éƒ½ä¼šç»™è¿™ä¸ªä»»åŠ¡ä¸€ä¸ª `context`ã€‚é‡Œé¢æœ‰ä¸€ä¸ª `waker`ï¼Œå¯ä»¥ç”¨æ¥æé†’ Executorâ€œå¯ä»¥è¿è¡Œ `poll()` äº†ã€‚â€

> å¦‚æœå¯¹è¿™æ–¹é¢æœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥å‚è€ƒ <https://weihanglo.tw/async-book/02_execution/03_wakeups.html>ã€‚å¦å¤– Future è¿˜æœ‰å¾ˆå¤šå¾ˆå¤šçš„çŸ¥è¯†ç‚¹ï¼ˆ`Pin` ç­‰ç­‰ï¼‰ï¼Œç¢äºç¯‡å¹…å°±å…ˆæç½®ã€‚

### å»¶ä¼¸é˜…è¯»ï¼šPolling ç­‰å„ç§æ–¹å¼çš„ä¼˜åŠ£

Pollingï¼ˆè½®è¯¢ï¼‰ï¼Œç”¨ç¨‹åºå†™å‡ºæ¥æ˜¯åƒè¿™æ ·çš„ï¼š

```rs
loop {
  let status = task.poll();

  if let Polling::Ready(value) = status {
    return value;
  }

  continue;
}
```

è¿™æ ·æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿé¦–å…ˆå¼‚æ­¥ä»»åŠ¡é€šå¸¸è¦ä¸€æ®µæ—¶é—´æ‰ä¼šå®Œæˆï¼Œä¸€ç›´ `poll()` ä¸ä¼šåŠ å¿«è¿è¡Œé€Ÿåº¦ã€‚å¦‚æœçœŸè¿™æ ·å†™ï¼Œä¼šæµªè´¹å¾ˆå¤š CPU æ—¶é—´åœ¨æ²¡å¿…è¦çš„ `poll()` ä¸Šã€‚å¦å¤–ï¼Œ`loop {}` æ˜¯ä¸ª _blocking_ åŒæ­¥å‡½æ•°ï¼Œè¿™æ ·å­å†™ï¼Œä¸‹ä¸€ä¸ª `Future` æ˜¯è¿è¡Œä¸äº†çš„ã€‚

é‚£æ¢å¦ä¸€ç§æ–¹å¼å‘¢ï¼Ÿ

```rs
let (tx, rx) = std::sync::mpsc::channel();
let mut return_values = vec![];

for task in rx {
  let status = task.poll();

  if let Polling::Ready(value) = status {
    // ä¿å­˜å›ä¼ å€¼ï¼Œä¸å†æ’ç¨‹ã€‚
    return_values.push(value);
  } else {
    // ç»§ç»­æ’ç¨‹ã€‚
    tx.send(task);
  }
}
```

å…¶å®è¿™å°±ç›¸å½“äºåœ¨ `poll()` é˜¶æ®µå›ä¼  `Poll::Pending` å‰è°ƒç”¨ `wake_by_ref()`â€”â€”è¿™ä¸ªæ–¹æ³•è§£å†³äº† `loop {}` çš„é—®é¢˜ï¼Œä½†è¿˜æ˜¯æ²¡èƒ½è§£å†³â€œæ²¡å¿…è¦ `poll()` çš„é—®é¢˜ã€‚â€

å€˜è‹¥å¦‚æœæˆ‘ä»¬å¯ä»¥ç­‰åˆ°ä½œä¸šå®Œæˆï¼Œå†è¿è¡Œ `wake()` å‘¢ï¼Ÿè¦è¿™ä¹ˆåšï¼Œæˆ‘ä»¬å°±å¾—å…ˆçŸ¥é“â€œå·¥ä½œä»€ä¹ˆæ—¶å€™æ‰å®Œæˆï¼Ÿâ€å¦‚æœä»»åŠ¡æ˜¯ç”¨ callback æˆ– event å‘ŠçŸ¥ä»»åŠ¡çŠ¶æ€çš„ï¼Œé‚£å°±æ˜¯åœ¨æ”¶åˆ° eventã€æˆ– callback è§¦å‘è¿›è¡Œè°ƒç”¨ã€‚

> å»¶ä¼¸é˜…è¯»ï¼š<https://weihanglo.tw/async-book/02_execution/05_io.html>

## async å‡½æ•°ã€åŒºå—å’Œ await

ä¸Šé¢ä»‹ç»äº†å¾ˆå¤š Rust ä¸­ `Future` ä¸ `Executor` çš„ç†è®ºåŸºç¡€ï¼Œä½†å®åŠ¡ä¸Šæ²¡æœ‰è¿™ä¹ˆéº»çƒ¦ã€‚äº‹å®ä¸Šåœ¨ Rust ä¸­ï¼Œç”¨ async å‡½æ•°å’Œ block æ˜¯éå¸¸ç›´è§‰çš„ã€‚

å°±ä»¥ä¸Šé¢çš„ [æ—©é¤ä¾‹å­](#åŒæ­¥-Synchronous-è·Ÿå¼‚æ­¥-Asynchoronous) æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå…ˆæ”¹å†™æˆè¿™æ ·ï¼š

```rs
async fn make_breakfast() -> Toast {
  let toast = bake_toast().await;
  let butter = prepare_peanut_butter().await;

  toast.apply(butter);
  toast
}
```

ä½ æˆ–è®¸ä¼šå¾ˆç–‘æƒ‘ä»–è·Ÿä¸‹é¢è¿™ä¸ªç‰ˆæœ¬æœ‰ä»€ä¹ˆå·®å¼‚ï¼š

```rs
fn make_breakfast() -> Toast {
  let toast = bake_toast();
  let butter = prepare_peanut_butter();

  toast.apply(butter);
  toast
}
```

é¦–å…ˆï¼Œè™½ç„¶æ•´ä½“ä¸Šâ€œåšæ—©é¤â€è¿˜æ˜¯å¾ªåºè¿è¡Œçš„ï¼ˆå…ˆçƒ¤å®Œåå¸ã€æ‰å‡†å¤‡èŠ±ç”Ÿé…±ï¼‰ï¼Œä½†åšæ—©é¤è¿™ä»¶äº‹æƒ…å› ä¸ºå·²ç»æ˜¯å¼‚æ­¥çš„äº†ï¼Œæ‰€ä»¥ä½ å¯ä»¥åœ¨åšæ—©é¤çš„æ—¶å€™åšå…¶ä»–äº‹æƒ…ï¼š

![Sync in Async](https://assets.blog.pan93.com/what-is-rust-async/sync-in-async.webp)

åè€…çš„è¯å°±æ˜¯çº¯ Syncï¼Œæ˜æ˜¾æ˜¯æ¯”å‰è€…ä½æ•ˆçš„ï¼š

![çº¯ Sync](https://assets.blog.pan93.com/what-is-rust-async/pure-sync.webp)

å¯¹ç…§å›¾ç‰‡ï¼Œæˆ–è®¸ä½ å‘ç°åˆ° `.await` åˆšå¥½å°±æ˜¯â€œä»»åŠ¡åˆ‡æ¢ç‚¹â€ã€‚`.await` ä¹‹åï¼Œä½ å¯ä»¥å»åšå…¶ä»–äº‹æƒ…ï¼ˆè€Œä¸æ˜¯ç©ºç­‰ï¼‰ã€‚ç­‰åˆ°çƒ¤ç®±å£°éŸ³å“äº†ä¹‹å ([`wake()`](#é«˜çº§é˜…è¯»future-ä¸-executor)) ä¹‹åå†å›æ¥åšå‰©ä¸‹çš„äº‹æƒ…ã€‚æ‰€ä»¥æ•´ä½“ä¸Š async å‡½æ•°æ˜¯æ¯”è¾ƒé«˜æ•ˆçš„ï¼Œä½†æˆ‘ä»¬è¦æ€ä¹ˆè®©æ•´ä¸ªä»»åŠ¡æ›´é«˜æ•ˆå‘¢ï¼ˆåœ¨ async é‡Œé¢ä¸€æ¬¡æ€§è¿è¡Œæ›´å¤šä»»åŠ¡ï¼Ÿï¼‰

### åœ¨ async å‡½æ•°é‡Œé¢å¹¶å‘è¿è¡Œæ•°ä¸ªä»»åŠ¡ (futures)

åˆšæ‰æåˆ°æˆ‘ä»¬å¸Œæœ›åœ¨ä¸€ä¸ª async é‡Œé¢ä¸€æ¬¡æ€§è¿è¡Œæ•°ä¸ªä»»åŠ¡ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ© `tokio` çš„ [`join!()`](https://docs.rs/tokio/latest/tokio/macro.join.html) å·¥å…·å·¨é›†ï¼Œè¡¨ç¤ºâ€œæˆ‘å¸Œæœ›è¿™ä¸¤ä¸ªä»»åŠ¡åŒæ—¶æ“ä½œâ€ï¼Œå°±åƒæ˜¯æŠŠè¿™ä¸¤ä¸ªä»»åŠ¡èåˆä¸ºä¸€äº†ï¼š

```rs
async fn make_breakfast() -> Toast {
  let (toast, butter) = tokio::join!(
    // è¦æ³¨æ„è¿™é‡Œä¸éœ€è¦ .awaitï¼Œ
    // await çš„äº‹æƒ… `join!()` ä¼šå¤„ç†ã€‚
    bake_toast(),
    prepare_peanut_butter()
  );

  toast.apply(butter);
  toast
}
```

è¿™æ · `make_breakfast` é‡Œé¢å°±æ˜¯é«˜æ•ˆçš„æ¨¡å¼äº†ï¼š

![Async in async](https://assets.blog.pan93.com/what-is-rust-async/async-in-async.webp)

é‚£æ¢ä¸€ç§ç°å®ä¸­ä¹Ÿå¸¸é‡åˆ°çš„ä¾‹å­ï¼šä½ å¸Œæœ›æ—©é¤å¯ä»¥åœ¨å°å­©ä¸Šå­¦å‰åšå®Œï¼Œå¦‚æœæ²¡åšå®Œå°±ä¸è¦ç»§ç»­åšäº†ã€‚æ‰€ä»¥æˆ‘ä»¬æƒ³è¦è®¾ç½®ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œå¦‚æœè®¡æ—¶åˆ°äº†è¿˜æ²¡åšå®Œå°±ç›´æ¥å–æ¶ˆï¼›åä¹‹å°±ç»§ç»­åšï¼š

![Async with timeout](https://assets.blog.pan93.com/what-is-rust-async/async-with-timeout.webp)

è¿™ç§æƒ…å†µå°±å¯ä»¥ç”¨ [`tokio::select!()`](https://docs.rs/tokio/latest/tokio/macro.select.html)â€”â€”åŒæ—¶ç­‰â€œåšæ—©é¤â€è·Ÿâ€œè®¡æ—¶å™¨â€ï¼Œå›ä¼ å®Œæˆé€Ÿåº¦æœ€å¿«çš„ä»»åŠ¡ï¼ˆåˆ†æ”¯ï¼‰ï¼Œè€Œå–æ¶ˆå‰©ä¸‹æ²¡åšå®Œçš„ä»»åŠ¡ï¼ˆåˆ†æ”¯ï¼‰ï¼š

```rs
// Option åŒ…å«â€œæœ‰â€æˆ–â€œæ²¡æœ‰â€ä¸¤ç§å¯èƒ½ã€‚å¦‚æœè®¡æ—¶å™¨åˆ°äº†ï¼Œ
// åå¸è¿˜æ²¡å®Œæˆï¼Œé‚£å°±æ²¡æœ‰æ—©é¤ï¼›åä¹‹ï¼Œå°±æœ‰æ—©é¤ã€‚
async fn make_breakfast_with_timer() -> Option<Toast> {
  tokio::select! {
    // å¦‚æœæ—©é¤å…ˆå®Œæˆï¼Œé‚£å°±æœ‰æ—©é¤ã€‚
    toast = make_breakfast() => Some(toast),

    // å¦‚æœæ—¶é—´å…ˆåˆ°ï¼Œé‚£å°±æ²¡æ—©é¤ã€‚
    _ = timer() => None,
  }
}

/// ä¸€ä¸ªè®¾ç½®åœ¨ 30 åˆ†é’Ÿçš„è®¡æ—¶å™¨
async fn timer() {
  tokio::time::sleep(
    std::time::Duration::from_secs(30 /* min */ * 60 /* sec */)
  ).await
}

async fn make_breakfast() -> Toast {
  let (toast, butter) = tokio::join!(
    bake_toast(),
    prepare_peanut_butter()
  );

  toast.apply(butter);
  toast
}
```

å¦‚æœä½ å¯¹è¿™æ–¹é¢å¾ˆæœ‰å…´è¶£ï¼Œå¯ä»¥çœ‹çœ‹ <https://weihanglo.tw/async-book/06_multiple_futures/01_chapter.html>ã€‚

### å»¶ä¼¸é˜…è¯»ï¼šawait åªèƒ½åœ¨ async function é‡Œé¢è¿è¡Œ

è¦æ³¨æ„çš„ï¼Œæ˜¯ `.await` åªèƒ½åœ¨ async block æˆ– async function é‡Œé¢ä½¿ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ ä¸èƒ½åœ¨åŒæ­¥å‡½æ•°ï¼ˆåŒ…æ‹¬ `main()`ï¼‰é‡Œé¢è°ƒç”¨å¼‚æ­¥å‡½æ•°ï¼š

```rs
fn main() {
  // ä¼šç¼–è¯‘é”™è¯¯ï¼
  let file_content = make_breakfast().await;

  // è¿˜æ˜¯ä¸è¡Œ ğŸ˜„
  let file_content = async {
    make_breakfast().await
  }.await; /* async block ä¹Ÿéœ€è¦ await */
}
```

æ—¢ç„¶æ¯ä¸ªè°ƒç”¨è€…éƒ½å¿…é¡»æ˜¯ async çš„ï¼Œ**é‚£æ˜¯è°è°ƒç”¨ç¬¬ä¸€ä¸ª async å‡½æ•°å‘¢ï¼Ÿ** [è¿™å°±å¾—æåˆ° Async Runtime äº†ã€‚](#rust-çš„-async-runtime)

### é«˜çº§é˜…è¯»ï¼šä» Future çœ‹ async å’Œ await

ä½†è¿™é‡Œé¢çš„ async å’Œ await åˆ†åˆ«ä»£è¡¨ä»€ä¹ˆæ„ä¹‰å‘¢ï¼Ÿ`async fn` å…¶å®å±•å¼€æ¥çœ‹ï¼Œå°±æ˜¯ä¸€ä¸ªå›ä¼  Future çš„å‡½æ•°ï¼š

```rs
struct ReadFileFuture { ... }

impl Future for ReadFileFuture {
  type Output = String;

  fn poll(...) { ... }
}

fn read_file(path: &Path) -> ReadFileFuture {}
```

è€Œ await çš„å¤§è‡´æ„æ€å°±æ˜¯â€œæ²¡å®Œæˆå°±è¯´æ•´ä¸ªå‡½æ•°æ²¡å®Œæˆï¼›å®Œæˆå°±ç»§ç»­â€ï¼š

```rs
// æŠŠè¿™ä¸ªå‡½æ•°çš„ context è½¬äº¤ç»™ read_to_string
let content_status = tokio::fs::read_to_string(path).poll(cx);

let content = match content_status {
  // å¦‚æœè¿™ä¸ª feature æ²¡å®Œæˆï¼Œå°±å‰©ä¸‹çš„ async ä¹Ÿå°±æ— æ³•ç»§ç»­ã€‚
  Poll::Pending => return Poll::Pending,

  // åä¹‹ï¼ŒæŠŠå€¼æ‹¿å›æ¥
  Poll::Ready(c) => c,
}
```

å®é™…ä¸Šè¿™éƒ¨åˆ†è¿˜æœ‰è®¸å¤šåœ°æ–¹éœ€è¦è€ƒè™‘ï¼šåŒ…æ‹¬è¦æ€ä¹ˆåœ¨ä¸‹æ¬¡è°ƒç”¨ `poll()` çš„æ—¶å€™ï¼ŒçŸ¥é“ç°åœ¨è¦ç»§ç»­è¿è¡Œå“ªä¸ª `Future`ã€‚æ›´è¯¦ç»†çš„ä¿¡æ¯å¯ä»¥å‚è€ƒ <https://weihanglo.tw/async-book/02_execution/02_future.html>ã€‚

## Rust çš„ async runtime

å®åŠ¡ä¸Šä½ ä¸éœ€è¦è‡ªå·±å†™ä¸€ä¸ª executorï¼Œ**è€Œæ˜¯ä½¿ç”¨ç°æˆçš„ async runtimeï¼ˆè¿è¡Œé˜¶æ®µã€è¿è¡Œæ—¶ï¼‰**ã€‚ä¸€ä¸ª **async runtime** é™¤äº† executor ä¹‹å¤–ï¼Œè¿˜æœ‰æä¾›å¾ˆå¤šåŠŸèƒ½ï¼ˆæ¯”å¦‚ä¸Šæ–‡æåŠçš„ thread poolã€å·¥å…·å·¨é›†å’Œå‡½æ•°ï¼Œä»¥åŠæ–‡ä»¶è¯»å†™ã€channel ç­‰ç­‰å¸¸ç”¨åŠŸèƒ½çš„å¼‚æ­¥å¯¹åº”æ–¹æ³•ï¼‰ã€‚

å¸¸è§çš„ async runtime æœ‰ `tokio`ã€`async-std` å’Œ `smol`ï¼Œå…¶ä¸­åˆä»¥ `tokio` å’Œ `async-std` ä¸ºå¤§å®—ã€‚ä¸‹æ–‡ä¼šä»¥ `tokio` ä½œä¸ºä»‹ç»ç¤ºä¾‹ã€‚

### è®© `main()` å˜æˆ async å‡½æ•°çš„èµ·æºåœ°

æˆ‘ä»¬åœ¨[ã€ˆå»¶ä¼¸é˜…è¯»ï¼šawait åªèƒ½åœ¨ async function é‡Œé¢è¿è¡Œã€‰](#å»¶ä¼¸é˜…è¯»await-åªèƒ½åœ¨-async-function-é‡Œé¢è¿è¡Œ)é‡Œé¢æœ‰æåŠâ€œæ‰€æœ‰è°ƒç”¨è€…å¿…é¡»éƒ½æ˜¯ _async function_ï¼Œâ€é‚£ `main()` å‘¢ï¼Ÿ

è¿˜è®°å¾—ä¸Šæ–‡æœ‰æåˆ°â€œFutures éœ€è¦ä¸€ä¸ª _executor_ è°ƒåº¦ï¼Ÿâ€é‚£ `main()` åŸåˆ™ä¸Šå°±æ˜¯é…ç½® runtimeï¼Œè®© runtime å‡†å¤‡ executor çš„åœ°æ–¹ï¼š

```rs
fn main() {
  // è®¾ç½®å¤šçº¿ç¨‹çš„ tokio runtimeã€‚
  tokio::runtime::Builder::new_multi_thread()
    // æ¿€æ´»æ‰€æœ‰åŠŸèƒ½ã€‚
    .enable_all()
    // å»ºæ„ runtimeã€‚
    .build()
    // å¦‚æœ runtime å»ºæ„å¤±è´¥å°±åœä½æ•´ä¸ªç¨‹åºã€‚
    .unwrap()
    // async å‡½æ•°çš„èµ·æºåœ°â€”â€”å µå¡ (blocking)ï¼Œ
    // è®©æ•´ä¸ª main() ç­‰å¾…è¿™ä¸ª async å‡½æ•°å®Œæˆã€‚
    .block_on(async {
        println!("Hello world");
    })

  // ç„¶åç¨‹åºå°±å¯ä»¥ç»“æŸäº†ã€‚
}
```

ä¸è¿‡å…¶å®ä¸ç”¨è¿™ä¹ˆéº»çƒ¦ï¼š[`tokio::main!`](https://docs.rs/tokio/latest/tokio/attr.main.html) è¿™ä¸ª **å±æ€§å·¨é›† (attribute macro)** å°±èƒ½å¸®ä½ å†™å¥½è¿™æ–¹é¢çš„åˆå§‹åŒ–äº†ã€‚ä½ åªè¦è¿™æ ·å°±å¥½ï¼š

```rs
#[tokio::main]
async fn main() {
  println!("Hello, World!");
}
```

### é«˜çº§é˜…è¯»ï¼šè®©ä¸€ä¸ªä»»åŠ¡ (Future) å˜æˆä¸€ä¸ªç»¿è‰²çº¿ç¨‹ (Green Thread)â€”â€”`spawn`

è¿˜è®°å¾—å¹¶å‘ (Concurrent) è·Ÿå¹¶è¡Œ (Parallelism) å—ï¼Ÿè™½ç„¶å¤§éƒ¨åˆ†çš„æƒ…å†µä¸‹ï¼Œåœ¨ **å•çº¿ç¨‹**â€œå¹¶å‘â€å°±å·²ç»å¾ˆè¶³å¤Ÿå¿«äº†ã€‚å€˜è‹¥è¿™ä¸ªä»»åŠ¡è€—æ—¶å¾ˆé•¿ï¼Œä½ å¸Œæœ›å¼€å¦ä¸€æ¡çº¿ç¨‹â€œå¹¶è¡Œâ€ä¸“é—¨å¤„ç†è¿™ä¸ªä»»åŠ¡ï¼Œé‚£å°±å¯ä»¥ç”¨ `spawn`ï¼š

```rs
let handle = tokio::task::spawn(async {
  /* ç°åœ¨è¿™é‡Œé¢çš„ä¸œè¥¿ï¼Œéƒ½åœ¨ç‹¬ç«‹çš„ thread é‡Œé¢è·‘äº†ï¼ */
});
```

[`tokio::task::spawn`](https://docs.rs/tokio/latest/tokio/task/fn.spawn.html) è™½ç„¶ç”¨èµ·æ¥å¾ˆåƒåˆ›å»º OS thread çš„ `std::thread::spawn`ï¼Œä½† **spawn é‡Œé¢ä¸è¦æ”¾é«˜è€—æ—¶çš„åŒæ­¥å‡½æ•°**â€”â€”é™¤éä½ ä¹è§æ•´ä¸ª runtime è¢«å¡åœ¨ä¸€ä»¶ä»»åŠ¡ä¸Šé¢ï¼ˆæˆ–è€…æ˜¯ç›´æ¥æŠŠ runtime ææ­»ï¼Œç›´æ¥ panicï¼ï¼‰

é‚£è¦æ€ä¹ˆåœ¨å¼‚æ­¥å‡½æ•°é‡Œé¢ï¼Œå¼€å¦ä¸€ä¸ª thread è·‘åŒæ­¥å‡½æ•°å‘¢ï¼Ÿä½ å¯ä»¥ç”¨æ¥ä¸‹æ¥ä¼šæåˆ°çš„ `tokio::task::spawn_blocking`ã€‚

### åœ¨å¼‚æ­¥å‡½æ•°é‡Œé¢è°ƒç”¨é«˜è€—æ—¶åŒæ­¥å‡½æ•°â€”â€”`spawn_blocking`

é™¤äº†å¼€ä¸€ä¸ª `std::thread::spawn` OS thread è·‘è¿™ç§å‡½æ•°ä¹‹å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨
[`tokio::task::spawn_blocking`](https://docs.rs/tokio/latest/tokio/task/fn.spawn_blocking.html) å¼€ä¸€ä¸ª **å¯ä»¥ await** çš„åŒæ­¥ _blocking_ å µå¡å‡½æ•°ã€‚

```rs
let _this_returns_42 = tokio::task::spawn_blocking(|| {
  for i in 0..114514 {
    for j in 0..1919810 {}
  }

  42
}).await;
```

è¿™æ ·å­è·‘é«˜è€—æ—¶çš„å‡½æ•°ä¹‹æ—¶ï¼Œç…§æ ·å¯ä»¥è¿è¡Œå…¶ä»–ä¸ç”¨å µå¡çš„ä»»åŠ¡ã€‚åŒç†ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠè¿™ä¸ªå¥—è¿›å» `join!` å¹¶å‘å®Œæˆï¼Œå¯æ˜¯ **è¿™æ ·åˆ›å»ºå‡ºçš„ thread æ˜¯å–æ¶ˆä¸äº†çš„â€”â€”ä¸åªæ˜¯å•çº¯çš„ `select!`ï¼Œè¿˜åŒ…å« `.abort()`** ã€‚å› æ­¤è¿˜æ˜¯å°½é‡é€‰æ‹©å¹¶å–„ç”¨å¼‚æ­¥å‡½æ•°ã€‚æƒ³æ·±å…¥äº†è§£ sync å‡½æ•°ä¸ async å‡½æ•°æ¡¥æ¥çš„ä¿¡æ¯ï¼Œå¯ä»¥å‚è€ƒ <https://tokio.rs/tokio/topics/bridging>ã€‚

## ç»“è¯­

åŸºæœ¬ä¸ŠæŠŠè¿™åˆ™ Twitter æ¨æ–‡æƒ³è¦çŸ¥é“çš„å¤§éƒ¨åˆ†çŸ¥è¯†ç‚¹éƒ½è®²äº†ã€‚ç¢äºä¸ªäººèƒ½åŠ›ä¸è¶³ï¼Œæˆ–è®¸è®²å¾—ä¸å¤Ÿæ¸…æ™°æˆ–ä¸ç”šæ˜ç¡®ï¼Œä¹Ÿååˆ†æ¬¢è¿å„è·¯ä¸“å®¶æŒ‡æ­£ QQ

å¦å¤–è¿™ç¯‡æ–‡ç« èŠ±äº†æˆ‘ 7hr æ¥å†™ï¼Œå¦‚æœè§‰å¾—æœ‰ç”¨çš„è¯ï¼Œæ¬¢è¿æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™æ›´å¤šå¯¹ async ä»¥åŠ Rust å¼‚æ­¥ç¨‹åºæœ‰å…´è¶£çš„äºº owo è°¢è°¢ ğŸ™

![7hr!!!](https://assets.blog.pan93.com/what-is-rust-async/how-long-i-wasted.webp)

å¦å¤–ä¹Ÿå¯ä»¥ follow æˆ‘çš„ [GitHub](http://github.com/pan93412) æ”¯æŒæˆ‘çš„ OSS å·¥ä½œ ouo

## å‚è€ƒæ–‡çŒ®

- <https://medium.com/erens-tech-book/%E7%90%86%E8%A7%A3-process-thread-94a40721b492>
- <https://hackmd.io/@sysprog/concurrency/https%3A%2F%2Fhackmd.io%2F%40sysprog%2FS1AMIFt0D#Concurrency-%E4%B8%A6%E8%A1%8C-vs-Parallelism-%E5%B9%B3%E8%A1%8C>
- <https://weihanglo.tw/async-book/02_execution/02_future.html>
- <https://en.wikipedia.org/wiki/Scheduling_(computing)>
- <https://zh.wikipedia.org/wiki/ç»¿è‰²çº¿ç¨‹>
- <https://doc.rust-lang.org/std/future/trait.Future.html>
- and more, a lot. Thanks to these authors â¤ï¸
